---
title: Redis知识归纳(五)Redis常见问题
date: 2020-04-04 15:43:21
tags: Redis
categories: Redis
---

Redis的雪崩、穿透、击穿是最为常见问题，这篇文章就对着几个问题进行总结。

<!-- more -->

### 缓存雪崩

缓存雪崩指的是瞬间缓存全面失效，大量请求落到数据库上，导致数据库压力瞬间增大，导致数据库崩溃，系统崩溃。这就是缓存雪崩。

如果是因为缓存在同一时间过期的原因，那么可以将过期时间设置分散。

如果是因为redis故障，我们可以从事前事中事后三个方面来进行预先准备和故障发生时应急方案:

1. 事前：redis高可用，主从+哨兵、redis cluster，避免全面崩溃
2. 事中：本地ehcache缓存 + hystrix 限流和降级，避免mysql被打死
先查本地ehcache缓存，没有再查redis，如果都没有，再查数据库，将数据库中的结果写到ehcache和redis中；限流组件设置每秒请求，有多少能通过组件，剩余的没有通过的则走降级。
3. 事后：redis持久化机制，一旦重启，自动从磁盘上加载数据，快速恢复缓存数据

### 缓存穿透

大量的无校查询，缓存中没有，从而全部落到数据库上，直接把数据库给搞崩溃了。比如，数据库id从1开始自增，结果大量请求都是-1，这种恶意攻击场景的缓存穿透就直接把系统搞崩溃了。

对于缓存穿透，在接口层进行校验，不合法的参数直接拒绝。对于没有查到的数据，就设置一个空值到缓存中，比如 set -999 unknown，然后设置过期时间，下次相同key来访问时，直接从缓存中取数据。

甚至可以使用布隆过滤器。布隆过滤器的原理是由N个hash算法和一个bitmap组成。分别通过哈希函数计算出哈希值，把这个值对应数组上的位置标记为1。当有元素查询的时候，同样通过是哈希函数映射位数组的点，只要有一个点不为1，说明该元素肯定不在集合中，如果全部带点为1，那么该元素可能存在集合中。

### 缓存击穿

缓存击穿意思是：某个key非常热点，访问非常频繁，突然当这个key在失效的瞬间，大量的请求击穿了缓存，全部落在数据库，从而导致系统崩溃。

在不同场景下的解决方式不同：

1. 如果缓存的数据基本上不会发生更新，那么可以尝试将该热点数据设置为永不过期
2. 如果缓存的数据更新不频繁，并且缓存刷新整个流程耗时较少，那么则可以使用分布式锁保证少量请求可以访问数据库，从而更新缓存，其他线程在锁释放后能够访问到新缓存。
3. 如果缓存的数据更新频繁或者缓存刷新流程耗时较长，那么可以利用定时任务在缓存过期前重新构建缓存或者延后缓存过期时间，保证所有请求都能一直访问到对应缓存。