---
title: 陆金所、平安金服面试总结
date: 2020-05-09 14:10:11
tags: 面试
categories: 杂谈
---

上午完成了陆金所的面试，总体来说感受还行，当然中间过程也被打击了，还是有很多知识点没有涉及到，下面来做个总结。

<!-- more -->

#### Http与Https有什么区别？

首先 HTTP协议有三个版本：
1. HTTP1.0
2. HTTP1.1
3. HTTP/2

HTTP1.0 和 HTTP1.1最主要的区别是：
HTTP1.1默认是 **持久化连接**，而HTTP1.0则是短链接。简单的说，就是每次与服务器交互，都需要新开一个连接。

因此如果每个请求都建立一个连接，HTTP协议是基于TCP协议的，TCP每次都需要经过三次握手，四次挥手，慢启动等，这个过程是非常消耗资源的。

而HTTP1.1默认使用了持久化连接来解决：建立一次连接，多次请求均由这个连接来完成。

HTTP2与HTTP1.1的区别在于：HTTP2解决了线头阻塞的问题，最重要的的改动是：多路复用。多路复用意味着线头阻塞将不再是个问题，允许通过单一的HTTP2连接发起多重的请求-响应消息。

所以回到HTTPS，HTTPS其实就是在HTTP协议下多加了一层SSL协议。HHTP协议以明文方式发送内存，不提供任何方式的数据加密。而HTTPS采用的是混合方式加密。
工作流程是：
1. 客户端发起HTTPS请求，连接到服务端的443端口。
2. 采用HTTPS协议的服务器会有一套数字证书，服务端会将这个证书发给客户端
3. 客户端的TLS会对证书进行解析，如果证书没有问题则会生成一个随机值，随后用证书对随机值进行加密，并且将这个证书加密后的随机值发送给服务端。
4. 服务端用私钥解密后，等到了客户端传送的随机值。此时一个非对称加密过程结束，可以看出TLS利用非对称加密实现身份认证和密钥协商。随后将通信内容通过随机值进行对称加密，发送给客户端。
5. 客户端收到内容后，用随机值进行解密。此时一个对称加密的过程结束。

#### 如何设计一个秒杀系统？

1. 秒杀系统独立部署、数据库分库，独立部署秒杀数据库
2. 秒杀连接加密，把秒杀URL动态化加密
3. Redis集群部署
4. Nginx负载均衡，在秒杀期间部署多台机器
5. 前端资源静态化，按钮置灰等
6. 库存预热：提前把商品库存加载到Redis中，扣减库存时先操作redis，等秒杀结束后再去修改数据库库存。
7. 秒杀开始后限流&降级&熔断&隔离：前端限流，页面点击次数限制；后端限流：Sentinel、Hystrix
8. Redis库存扣减时使用Lua脚本。Lua脚本将多条命令一起执行，具有原子性。
9. 如果是多个商品，那么可以使用MQ进行削峰填谷，队列串行修改库存。

**令牌桶算法**

令牌桶算法用来控制发送到网络上的数据的数目，并允许突发数据的发送。

原理是:系统会以一个恒定的速度往桶里面放入令牌，如果请求需要被处理，则需要先从桶里获取一个令牌，当桶里没有令牌可取时，则拒绝服务。

Google的Guava包中的RateLimiter类就是令牌桶算法的解决方案。

**漏桶算法**

漏桶算法则是请求先进入漏桶，漏桶以一定速度出水，当水流速度过大时会直接溢出，漏桶算法能强行限制数据的传输速度。

**两者区别**

漏桶算法能强行限制数据的传输速率，而令牌桶算法能够在限制数据的平均传输速度外，还允许某种程度的突发传输，因此它适合具有突发特性的流量。

#### Linux如何查看端口占用情况

1. 查找被占用端口
**netstat -tln**
2. 查看端口属于哪个程序？
**lsof -i :8080**

#### 如何实现跨线程间的传递数据？

可以使用阿里开源的TTL:TransmittableThreadLocal 

当被问到 不使用开源，还能有什么办法？我竟一时懵逼了。

我们可以将需要传递的数据放在JVM内存的一个map里面，key为线程ID，value为需要传递的值；或者将这个map放到redis等公共空间都可以。

#### 如何避免MySQL死锁？

1. 对索引加锁顺序不一致可能会导致死锁，如果可以，尽量以相同顺序来防伪索引记录和表。
2. Gap锁有可能对导致死锁，Mysql的隔离界别是RR，使用行锁+Gap锁来解决幻读问题，如果幻读问题影响不大，那么可以考虑将隔离级别更改为RC。
3. 为表增加合适的索引，因为不走索引的情况，会对表加锁，死锁概率提高。
4. MyISAM只支持表锁，采用一次封锁技术来保证事务之间不会发送死锁。我们也可以采用同样的思想，在事务中一次锁定所需要的全部资源，减少死锁概率。
5. 将大事务拆分为小事务。
6. 避免同一时间运行多个对同一表进行读写的脚本。定时任务等
7. 设置锁等待超时参数innodb_lock_wait_timeout。


> 参考列表
> 
> 1. https://www.aneasystone.com/archives/2018/04/solving-dead-locks-four.html
> 2. https://www.jianshu.com/p/a59c13e70582
> 3. https://www.zhihu.com/question/54895548
待续~~~


